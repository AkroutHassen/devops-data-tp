name: deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io/akrouthassen
  IMAGE_TAG: ${{ github.sha }}
  GCP_PROJECT_ID: serene-epsilon-477209-m0
  GKE_CLUSTER: autopilot-cluster-1
  GKE_LOCATION: europe-west1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push post_pusher
        run: |
          docker build -t $REGISTRY/post-pusher:$IMAGE_TAG -f post_pusher/Dockerfile .
          docker push $REGISTRY/post-pusher:$IMAGE_TAG

      - name: Build & push post_api
        run: |
          docker build -t $REGISTRY/post-api:$IMAGE_TAG -f post_api/Dockerfile .
          docker push $REGISTRY/post-api:$IMAGE_TAG

      - name: Build & push post_consumer
        run: |
          docker build -t $REGISTRY/post-consumer:$IMAGE_TAG -f cours_kafka/post_consumer/Dockerfile .
          docker push $REGISTRY/post-consumer:$IMAGE_TAG

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/get-gke-credentials@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}

      
      - name: Create namespace and deploy resources
        run: |
          kubectl get namespace cours-kubernetes || kubectl create namespace cours-kubernetes
          kubectl apply -n cours-kubernetes -f k8s-secret.yaml
          kubectl apply -n cours-kubernetes -f k8s-configmap.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-consumer-configmap.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-consumer-secret.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-pusher.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-consumer.yaml
          kubectl apply -n cours-kubernetes -f cours_kafka/kafka/deployment.yaml
          kubectl apply -n cours-kubernetes -f cours_kafka/kafka/service.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-api.yaml

      - name: Set new image tags
        run: |
          kubectl -n cours-kubernetes set image deploy/post-pusher post-pusher=$REGISTRY/post-pusher:$IMAGE_TAG
          kubectl -n cours-kubernetes set image deploy/post-consumer post-consumer=$REGISTRY/post-consumer:$IMAGE_TAG
          kubectl -n cours-kubernetes set image deploy/post-api post-api=$REGISTRY/post-api:$IMAGE_TAG

      - name: Wait for rollouts
        run: |
          kubectl -n cours-kubernetes rollout status deploy/post-pusher
          kubectl -n cours-kubernetes rollout status deploy/post-consumer
          kubectl -n cours-kubernetes rollout status deploy/post-api

      - name: Show pod status
        run: |
          kubectl get pods -n cours-kubernetes -o wide
          for pod in $(kubectl get pods -n cours-kubernetes -o jsonpath='{.items[*].metadata.name}'); do kubectl describe pod $pod -n cours-kubernetes; done