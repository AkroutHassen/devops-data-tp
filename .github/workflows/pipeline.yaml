name: deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io/akrouthassen
  IMAGE_TAG: ${{ github.sha }}
  GCP_PROJECT_ID: serene-epsilon-477209-m0
  GKE_CLUSTER: autopilot-cluster-1
  GKE_LOCATION: europe-west1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push post_pusher
        run: |
          docker build -t $REGISTRY/post-pusher:$IMAGE_TAG -f post_pusher/Dockerfile .
          docker push $REGISTRY/post-pusher:$IMAGE_TAG

      - name: Build & push post_api
        run: |
          docker build -t $REGISTRY/post-api:$IMAGE_TAG -f post_api/Dockerfile .
          docker push $REGISTRY/post-api:$IMAGE_TAG

      - name: Build & push post_consumer
        run: |
          docker build -t $REGISTRY/post-consumer:$IMAGE_TAG -f cours_kafka/post_consumer/Dockerfile .
          docker push $REGISTRY/post-consumer:$IMAGE_TAG

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}

      - name: Ensure namespace
        run: |
          kubectl get namespace cours-kubernetes || kubectl create namespace cours-kubernetes

      - name: Deploy MongoDB (StatefulSet)
        run: |
          if ! kubectl -n cours-kubernetes apply -f k8s-mongodb.yaml; then
            echo "MongoDB StatefulSet apply failed (likely immutable field change). Recreating statefulset/mongodb..."
            kubectl -n cours-kubernetes delete statefulset mongodb --ignore-not-found
            kubectl -n cours-kubernetes apply -f k8s-mongodb.yaml
          fi

      - name: Deploy app secrets & config
        run: |
          kubectl apply -n cours-kubernetes -f k8s-configmap.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-consumer-configmap.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-consumer-secret.yaml

      - name: Deploy Kafka
        run: |
          kubectl apply -n cours-kubernetes -f cours_kafka/kafka/deployment.yaml
          kubectl apply -n cours-kubernetes -f cours_kafka/kafka/service.yaml
      
      - name: Deploy Kafka ui
        run: |
          kubectl apply -n cours-kubernetes -f cours_kafka/ui/deployment.yaml
          kubectl apply -n cours-kubernetes -f cours_kafka/ui/service.yaml

      - name: Deploy apps
        run: |
          kubectl apply -n cours-kubernetes -f k8s-post-pusher.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-consumer.yaml
          kubectl apply -n cours-kubernetes -f k8s-post-api.yaml

      - name: Update images (new tag)
        run: |
          kubectl -n cours-kubernetes set image deploy/post-pusher post-pusher=$REGISTRY/post-pusher:$IMAGE_TAG
          kubectl -n cours-kubernetes set image deploy/post-consumer post-consumer=$REGISTRY/post-consumer:$IMAGE_TAG
          kubectl -n cours-kubernetes set image deploy/post-api post-api=$REGISTRY/post-api:$IMAGE_TAG

      - name: Wait for rollouts
        run: |
          kubectl -n cours-kubernetes rollout status deploy/kafka-broker --timeout=600s || true
          kubectl -n cours-kubernetes rollout status statefulset/mongodb --timeout=600s
          kubectl -n cours-kubernetes rollout status deploy/post-pusher --timeout=600s
          kubectl -n cours-kubernetes rollout status deploy/post-consumer --timeout=600s
          kubectl -n cours-kubernetes rollout status deploy/post-api --timeout=600s

      - name: Show pod status
        run: |
          kubectl get pods -n cours-kubernetes -o wide

      - name: Debug (events + describes) on failure
        if: failure()
        run: |
          echo "==== pods ===="
          kubectl get pods -n cours-kubernetes -o wide || true
          echo "==== events (last 120) ===="
          kubectl -n cours-kubernetes get events --sort-by=.metadata.creationTimestamp | tail -n 120 || true
          echo "==== mongodb describe ===="
          kubectl -n cours-kubernetes describe statefulset mongodb || true
          kubectl -n cours-kubernetes describe pod -l app=mongodb || true
          echo "==== post-consumer logs (tail) ===="
          kubectl -n cours-kubernetes logs deploy/post-consumer --tail=200 || true
          echo "==== post-pusher logs (tail) ===="
          kubectl -n cours-kubernetes logs deploy/post-pusher --tail=200 || true
          echo "==== post-api logs (tail) ===="
          kubectl -n cours-kubernetes logs deploy/post-api --tail=200 || true